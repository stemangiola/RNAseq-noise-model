---
title: "SBC tests of models"
output: html_notebook
---

```{r setup}
devtools::load_all()
library(here)
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(tidyverse)
library(cowplot)

```

```{r}
model_multinomial = stan_model(here("stan","multinomial.stan"))
model_nb_multinomial_approx = stan_model(here("stan","nb_multinomial_approx.stan"))
```

```{r}
G = 5
N = 10
sums = G * 10 + rnbinom(N, mu = G * 50, size = 1)

generator <- function() { generate_data_multinomial(G, sums, sigma_prior_type = "normal") }
sbc_res <- sbc(model_multinomial, generator, 50, control = list(adapt_delta = 0.9))
plot_sbc(sbc_res)
```
```{r}
G = 5
N = 10
sums = rnbinom(N, mu = G * 50, size = 1)

generator <- function() { generate_data_nb_multinomial(G, sums, lambda_raw_sigma = 2)}
sbc_res <- sbc(model_nb_multinomial_approx, generator, 50, control = list(adapt_delta = 0.9))
plot_sbc(sbc_res)
```

