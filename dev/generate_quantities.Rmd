---
title: "Generated quantities"
output: html_notebook
---

This notebook display the generated quantities of each model, with no data imput

```{r}

set.seed(13254)

# Import libraries
library(tidyverse)
library(magrittr)
library(rstan)
library(tidybayes)
setwd("~/PostDoc/RNAseq-noise-model")
```

Setting data

```{r}

# Import gene transcription data set
counts_tidy = 
  read_csv("data/tibble_TCGA_files/Acute_Myeloid_Leukemia_Primary_Blood_Derived_Cancer_-_Peripheral_Blood.csv") %>%
  mutate_if(is.character, as.factor) %>%
  filter(sample %in% ( (.) %>% distinct(sample) %>% head(n=50) %>% pull(sample)) ) %>%
  filter(ens_iso %in% ( (.) %>% distinct(ens_iso) %>% head(n=100) %>% pull(ens_iso)) ) 
counts = 
  counts_tidy %>% 
  select(ens_iso,`read count`,sample) %>% 
  spread(ens_iso, `read count`) %>% 
  select(-sample) %>% 
  as.matrix()
  
# Info on data set
N = counts_tidy %>% distinct(sample) %>% nrow
G = counts_tidy %>% distinct(ens_iso) %>% nrow
my_prior = c(0,5)
omit_data = 0
exposure = counts_tidy %>% group_by(sample) %>% summarise(`Total counts` = sum(`read count`)) %>% pull(`Total counts`)

```

Simulate data from Negative Binomial model

```{r}

# Fit model
negBinomial_model = stan_model("stan/negBinomial.stan")
negBinomial_fit = sampling(negBinomial_model, cores = 4)

# Check fit and plot
negBinomial_gen = 
  negBinomial_fit %>% 
  { 
    (.) %>% check_all_diagnostics()
    (.)
  } %>% 
  gather_samples(counts_gen[N, G]) 

# Plot
negBinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10()

```

Simulate data from Multinomial model

```{r}

# Fit model
multinomial_model = stan_model("stan/multinomial.stan")
multinomial_fit = sampling(multinomial_model, cores = 4, iter = iterations)

# Check fit and plot
multinomial_gen = 
  multinomial_fit %>% 
  { 
    (.) %>% check_all_diagnostics()
    (.)
  } %>% 
  gather_samples(counts_gen[N, G]) 

# Plot
multinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10()

```

Simulate data from Dirichlet-multinomial model

```{r}

# Fit model
dirichlet_multinomial_model = stan_model("stan/dirichlet_multinomial.stan")
dirichlet_multinomial_fit = sampling(dirichlet_multinomial_model, cores = 4)

# Check fit and plot
dirichlet_multinomial_gen = 
  dirichlet_multinomial_fit %>% 
  { 
    (.) %>% check_all_diagnostics()
    (.)
  } %>% 
  gather_samples(counts_gen[N, G]) 

# Plot
dirichlet_multinomial_gen  %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10()


```

Simulate data from logNormal-multinomial model

```{r}

# Fit model
logNormal_multinomial_model = stan_model("stan/logNormal_multinomial.stan")
logNormal_multinomial_fit = sampling(logNormal_multinomial_model, cores = 4)

# Check fit and plot
logNormal_multinomial_gen = 
  logNormal_multinomial_fit %>% 
  { 
    (.) %>% check_all_diagnostics()
    (.)
  } %>% 
  gather_samples(counts_gen[N, G]) 

# Plot
logNormal_multinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10()

```

```{r}

# Fit model
logStudent_multinomial_model = stan_model("stan/logStudent_multinomial.stan")
logStudent_multinomial_fit = sampling(logStudent_multinomial_model, cores = 4)

# Check fit and plot
logStudent_multinomial_gen = 
  logStudent_multinomial_fit %>% 
  { 
    (.) %>% check_all_diagnostics()
    (.)
  } %>% 
  gather_samples(counts_gen[N, G]) 

# Plot
logStudent_multinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10()
```


```{r}

mcmc_pairs(logStudent_multinomial_fit, pars = c("alpha[1]", "lambda[1]", "sigma"), off_diag_args = list(size = 1.5))

pairs(logStudent_multinomial_fit, pars = c("alpha[1]", "lambda[1]", "sigma"))
```


