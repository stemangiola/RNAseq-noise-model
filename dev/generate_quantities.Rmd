---
title: "Generated quantities"
output: html_notebook
---

This notebook display the generated quantities of each model, with no data imput

```{r setup}
# Import libraries

set.seed(13254)

# Import libraries
library(tidyverse)
library(magrittr)
library(rstan)
library(tidybayes)
library(here)
# library(future)
# plan(multiprocess)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

devtools::load_all()
```

Setting global variables

```{r}

N = 10 
G = 30 

# Import gene transcription data set
counts_tidy =
  read_csv(here("data", "tibble_TCGA_files/Acute_Myeloid_Leukemia_Primary_Blood_Derived_Cancer_-_Peripheral_Blood.csv")) %>%
  mutate_if(is.character, as.factor) %>%
  filter(sample %in% ( (.) %>% distinct(sample) %>% head(n=N) %>% pull(sample)) ) %>%
  filter(ens_iso %in% ( (.) %>% distinct(ens_iso) %>% head(n=G) %>% pull(ens_iso)) )
counts =
  counts_tidy %>%
  select(ens_iso,`read count`,sample) %>%
  spread(ens_iso, `read count`) %>%
  select(-sample) %>%
  as.matrix()

# Info on data set
my_prior = c(0,5)
omit_data = 0
exposure = counts_tidy %>% group_by(sample) %>% summarise(`Total counts` = sum(`read count`)) %>% pull(`Total counts`)

```
Wrappers

```{r}

check_return = function(fit){
  fit %>% check_all_diagnostics()
  fit
}

sampling_check_return = function(model, cores = 4, iter = 500){
  sampling(model, cores = cores, iter = iter) %>% check_return
}

```

Plottig functions

```{r}

# Set theme plots
my_theme = 	
	theme_bw() +
	theme(
		panel.border = element_blank(),
		axis.line = element_line(),
		panel.grid.major = element_line(size = 0.2),
		panel.grid.minor = element_line(size = 0.1),
		text = element_text(size=12),
		legend.position="bottom",
		aspect.ratio=1,
		axis.text.x = element_text(angle = 90, hjust = 1),
		strip.background = element_blank(),
		axis.title.x  = element_text(margin = margin(t = 10, r = 10, b = 10, l = 10)),
		axis.title.y  = element_text(margin = margin(t = 10, r = 10, b = 10, l = 10))
	)


```

Compile all models

```{r, echo=FALSE}

negBinomial_model = stan_model(here("stan","negBinomial.stan"))
multinomial_model = stan_model(here("stan","multinomial.stan"))
dirichlet_multinomial_model = stan_model(here("stan","dirichlet_multinomial.stan"))
logNormal_multinomial_model = stan_model(here("stan","logNormal_multinomial.stan"))
logStudent_multinomial_model = stan_model(here("stan","logStudent_multinomial.stan"))

```

Run all models

```{r}

negBinomial_fit = sampling_check_return(negBinomial_model)
multinomial_fit = sampling_check_return(multinomial_model) 
dirichlet_multinomial_fit = sampling_check_return(dirichlet_multinomial_model) 
logNormal_multinomial_fit = sampling_check_return(logNormal_multinomial_model) 
logStudent_multinomial_fit = sampling_check_return(logStudent_multinomial_model) 

```

Simulate data from Negative Binomial model

```{r}

# Fit model

# Check fit and plot
negBinomial_gen =
  negBinomial_fit %>%
  {
    (.) %>% check_all_diagnostics()
    (.)
  } %>%
  gather_samples(counts_gen[N, G])

# Plot
negBinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10() +
  my_theme

```

Simulate data from Multinomial model

```{r}

# Fit model

# Check fit and plot
multinomial_gen =
  multinomial_fit %>%
  {
    (.) %>% check_all_diagnostics()
    (.)
  } %>%
  gather_samples(counts_gen[N, G])

# Plot
multinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10() +
  my_theme

```

Simulate data from Dirichlet-multinomial model

```{r}

# Fit model

# Check fit and plot
dirichlet_multinomial_gen =
  dirichlet_multinomial_fit %>%
  {
    (.) %>% check_all_diagnostics()
    (.)
  } %>%
  gather_samples(counts_gen[N, G])

# Plot
dirichlet_multinomial_gen  %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10() +
  my_theme


```

Simulate data from logNormal-multinomial model

```{r}

# Fit model

# Check fit and plot
logNormal_multinomial_gen =
  logNormal_multinomial_fit %>%
  {
    (.) %>% check_all_diagnostics()
    (.)
  } %>%
  gather_samples(counts_gen[N, G])

# Plot
logNormal_multinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10() +
  my_theme

```

```{r}

# Fit model

# Check fit and plot
logStudent_multinomial_gen =
  logStudent_multinomial_fit %>%
  {
    (.) %>% check_all_diagnostics()
    (.)
  } %>%
  gather_samples(counts_gen[N, G])

# Plot
logStudent_multinomial_gen %>%
  filter(.iteration== 1 & .chain == 1) %>%
  ggplot(aes(estimate)) +
  geom_histogram() +
  scale_x_log10() +
  my_theme
```


```{r}

mcmc_pairs(logStudent_multinomial_fit, pars = c("alpha[1]", "lambda[1]", "sigma"), off_diag_args = list(size = 1.5))

pairs(logStudent_multinomial_fit, pars = c("alpha[1]", "lambda[1]", "sigma"))
```
