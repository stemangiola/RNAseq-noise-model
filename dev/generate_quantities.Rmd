---
title: "Generated quantities"
output: html_notebook
---

This notebook display the generated quantities of each model, with no data imput

```{r setup}
# Import libraries

set.seed(13254)

# Import libraries
library(tidyverse)
library(magrittr)
library(rstan)
library(tidybayes)
library(here)
library(foreach)
library(doParallel)
registerDoParallel()
# library(future)
# plan(multiprocess)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

devtools::load_all()
```

Setting global variables

```{r}

N = 20 
G = 50 

# Import gene transcription data set
counts_tidy =
  read_csv(here("data", "tibble_TCGA_files/Acute_Myeloid_Leukemia_Primary_Blood_Derived_Cancer_-_Peripheral_Blood.csv")) %>%
  filter(sample %in% ( (.) %>% distinct(sample) %>% head(n=N) %>% pull(sample)) ) %>%
  filter(ens_iso %in% ( (.) %>% distinct(ens_iso) %>% head(n=G) %>% pull(ens_iso)) ) %>%
  mutate_if(is.character, as.factor) %>%

  # Add numerical indexes
  left_join(
    (.) %>% 
      distinct(ens_iso) %>% 
      arrange(ens_iso) %>% 
      mutate(ens_iso_idx = 1:n())
  ) %>%
  left_join(
    (.) %>% 
      distinct(sample) %>% 
      arrange(sample) %>% 
      mutate(sample_idx = 1:n())
  )

# Produce input for Stan
counts =
  counts_tidy %>%
  select(ens_iso,`read count`,sample) %>%
  spread(ens_iso, `read count`) %>%
  select(-sample) %>%
  as.matrix()

# Info on data set
my_prior = c(0,5)
omit_data = 0
exposure = 
  counts_tidy %>% 
  group_by(sample) %>% 
  summarise(`Total counts` = sum(`read count`)) %>% 
  pull(`Total counts`)

```
Wrappers

```{r}

check_return = function(fit){
  fit %>% check_all_diagnostics()
  fit
}

sampling_check_return = function(model, cores = 4, iter = 500, ...){
  sampling(model, cores = cores, iter = iter, ...) %>% check_return
}

```

Plottig utilities

```{r}

# Set theme plots
my_theme = 	
	theme_bw() +
	theme(
		panel.border = element_blank(),
		axis.line = element_line(),
		panel.grid.major = element_line(size = 0.2),
		panel.grid.minor = element_line(size = 0.1),
		text = element_text(size=12),
		legend.position="bottom",
		aspect.ratio=1,
		axis.text.x = element_text(angle = 90, hjust = 1),
		strip.background = element_blank(),
		axis.title.x  = element_text(margin = margin(t = 10, r = 10, b = 10, l = 10)),
		axis.title.y  = element_text(margin = margin(t = 10, r = 10, b = 10, l = 10))
	)


plot_generated_quantities = function(gq){
  
  list(
    
    gq %>%
    filter(.iteration %in% 1:10 & .chain == 1) %>%
    ggplot(aes(`Read count`+1, color=.iteration)) +
  	stat_bin(geom = "step", position = "identity", bins=50) +
  	scale_x_log10() + 
  	my_theme +
    ggtitle("Iterations 1 to 10 grouped"),
    
    gq %>%
    filter(.iteration %in% 1:10 & .chain == 1) %>%
    ggplot(aes(`Read count`+1, color=.iteration)) +
  	stat_bin(geom = "step", position = "identity", bins=50) +
  	scale_x_log10() + 
  	my_theme +
    ggtitle("Iterations 1 to 10 together (roughly as if we had 1000 genes)")
  ) %>%
  cowplot::plot_grid(plotlist = ., align = "v",  axis="b", rel_widths = 1 )
  
}
```

Set model names

```{r}
# model_names = 
#   dir(path = here("stan"), pattern = ".stan") %>%
#   gsub("\\.stan", "", .)
model_names = c("negBinomial", "multinomial", "dirichlet_multinomial", "logNormal_multinomial", "logStudent_multinomial")

```

Compile all models

```{r, echo=FALSE}
models = 
  foreach(model_name = model_names) %dopar% {
    stan_model(here("stan",sprintf("%s.stan", model_name)))
  } %>% 
  setNames(model_names)
```

Run all models

```{r}
fits = 
  foreach(model = models, model_name = models %>% names) %do% {
    sampling_check_return(
      model, 
      control = list(
        max_treedepth = switch(
          model_name, 
          "logNormal_multinomial" = 12, 
          "logStudent_multinomial" = 13, 
          10
        ) 
      )
    )
  } %>% 
  setNames(model_names)

# # Fit a single model
# fits$logNormal_multinomial = sampling_check_return(
#       models$logNormal_multinomial, 
#       control = list( max_treedepth = 12)
# )
```


Get generated quantities

```{r}
generated_quant = 
  foreach(fit = fits, model_name = fits %>% names, .combine = bind_rows) %dopar% {
    fit %>%
      gather_samples(counts_gen[sample_idx, ens_iso_idx]) %>%
      mutate(model_name)
  } %>%
  left_join(counts_tidy) %>%
  rename(Observed = `read count`, Estimated = estimate)

```

Plots

```{r}

generated_quant %>%
  gather(`Source`, `Read count`, c("Observed", "Estimated")) %>%
  filter(.iteration %in% 1:50 & .chain %in% 1) %>%
  
  # Plot
  {
    ggplot((.), aes(`Read count` + 1, color = Source)) +
    stat_bin(geom = "step", position = "identity", bins=50) +
    facet_wrap(~ model_name) +
    scale_x_log10() +
    scale_color_brewer(palette = "Set1") +
    my_theme +
    ggtitle("Overall read count distribution") 
  } %>%
  
  # Save plot
  {
    ggsave(plot = (.), here("dev", "overall_read_count_distribution.png"))
    (.)
  }

```
